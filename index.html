<!doctype html>
<html>

<head>
	<meta charset="UTF-8">
	<title>analog keyboard overlay</title>
	<script type="module" src="browserInputOverlayView/default.js"></script>
	<link rel="stylesheet" href="browserInputOverlayView/_assets/style.css">
</head>

<body>

	<canvas id="canvas" width="1600" height="600" oncontextmenu="return false">
		Your browser does not support the HTML5 canvas tag.
	</canvas>
	<div id="propertyEditor" hidden oncontextmenu="return false">
		<p id="propertyEditorTitle">Window title text</p>
		<table id="propertyTable">
			<tr class="property">
				<td>fillStyle: </td>
				<td><input type="text" value="" class="inputBox fillStyle"></td>
			</tr>
		</table>
	</div>

	<!-- Bridge SDL gamepad and uiohook global input to Web APIs (Electron only) -->
	<script>
		// SDL gamepad state storage
		let sdlGamepads = [];

		// Override navigator.getGamepads() to return SDL state (blackbox approach)
		if (window.electronAPI) {
			const originalGetGamepads = navigator.getGamepads.bind(navigator);

			// Replace navigator.getGamepads() with SDL-backed version
			navigator.getGamepads = function() {
				// If SDL has gamepad data, return it; otherwise fall back to browser API
				if (sdlGamepads.length > 0) {
					// Convert to GamepadList-like array
					const result = [];
					for (let i = 0; i < 4; i++) { // Standard Gamepad API supports max 4 gamepads
						result[i] = sdlGamepads[i] || null;
					}
					return result;
				}
				// Fallback to browser's native gamepad API (when focused)
				return originalGetGamepads();
			};

			// Listen for SDL gamepad state updates
			let sdlDataReceived = false;
			window.electronAPI.onGlobalGamepadState((gamepads) => {
				if (!sdlDataReceived) {
					console.log('[Renderer] ✓ First SDL gamepad data received:', gamepads.length, 'controller(s)');
					if (gamepads.length > 0) {
						console.log('[Renderer] Controller 0:', gamepads[0].id, '- Axes:', gamepads[0].axes.length, 'Buttons:', gamepads[0].buttons.length);
					}
					sdlDataReceived = true;
				}
				sdlGamepads = gamepads;
			});

			console.log('[Renderer] ✓ SDL gamepad override active (navigator.getGamepads patched)');
		} else {
			console.log('[Renderer] ✗ electronAPI not found (running as web version)');
		}

		// uiohook keycode to KeyboardEvent.code mapping
		const UIOHOOK_TO_KEYCODE = {
			// Letters
			30: 'KeyA', 48: 'KeyB', 46: 'KeyC', 32: 'KeyD', 18: 'KeyE',
			33: 'KeyF', 34: 'KeyG', 35: 'KeyH', 23: 'KeyI', 36: 'KeyJ',
			37: 'KeyK', 38: 'KeyL', 50: 'KeyM', 49: 'KeyN', 24: 'KeyO',
			25: 'KeyP', 16: 'KeyQ', 19: 'KeyR', 31: 'KeyS', 20: 'KeyT',
			22: 'KeyU', 47: 'KeyV', 17: 'KeyW', 45: 'KeyX', 21: 'KeyY',
			44: 'KeyZ',
			// Numbers
			2: 'Digit1', 3: 'Digit2', 4: 'Digit3', 5: 'Digit4', 6: 'Digit5',
			7: 'Digit6', 8: 'Digit7', 9: 'Digit8', 10: 'Digit9', 11: 'Digit0',
			// Special keys
			57: 'Space', 28: 'Enter', 1: 'Escape', 14: 'Backspace',
			15: 'Tab', 42: 'ShiftLeft', 54: 'ShiftRight',
			29: 'ControlLeft', 97: 'ControlRight',
			56: 'AltLeft', 100: 'AltRight'
		};

		if (window.electronAPI) {
			console.log('[Renderer] ✓ electronAPI is available!');
			console.log('[Renderer] Has global input:', window.electronAPI.hasGlobalInput());
			console.log('[Renderer] Is readonly:', window.electronAPI.isReadonly());

			// Bridge uiohook events to synthetic DOM KeyboardEvents
			window.electronAPI.onGlobalKeyDown((data) => {
				console.log('[Renderer] IPC received keydown, keycode:', data.keycode);
				const code = UIOHOOK_TO_KEYCODE[data.keycode];
				if (code) {
					console.log('[Renderer] Dispatching synthetic keydown:', code);
					document.dispatchEvent(new KeyboardEvent('keydown', {
						code: code,
						bubbles: true,
						cancelable: true
					}));
				} else {
					console.warn('[Renderer] Unknown keycode:', data.keycode, '- add to mapping');
				}
			});

			window.electronAPI.onGlobalKeyUp((data) => {
				console.log('[Renderer] IPC received keyup, keycode:', data.keycode);
				const code = UIOHOOK_TO_KEYCODE[data.keycode];
				if (code) {
					console.log('[Renderer] Dispatching synthetic keyup:', code);
					document.dispatchEvent(new KeyboardEvent('keyup', {
						code: code,
						bubbles: true,
						cancelable: true
					}));
				}
			});

			console.log('[Renderer] ✓ Global input bridge active (uiohook → DOM events)');
		} else {
			console.log('[Renderer] ✗ electronAPI not found (running as web version)');
		}
	</script>
</body>

</html>
