name: Build Web App (Reusable)

on:
  workflow_call:
    inputs:
      deploy-path:
        description: 'Deployment path (empty for root, "experimental" for subdirectory)'
        required: false
        type: string
        default: ''

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies and build
        run: |
          cd SourceCode/_devTools
          npm ci
          ln -s $(pwd)/node_modules ../WebApp/node_modules
          ln -s $(pwd)/node_modules ../DesktopWrappedWebapp/node_modules
          npm run build

      - name: Deploy to GitHub Pages (gh-pages branch)
        run: |
          cd SourceCode/WebApp
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Clone or create gh-pages branch
          git clone --single-branch --branch gh-pages https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git gh-pages-temp 2>/dev/null || \
            git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git gh-pages-temp

          cd gh-pages-temp
          git checkout gh-pages 2>/dev/null || git checkout --orphan gh-pages

          # Deploy to root or subdirectory
          if [ -z "${{ inputs.deploy-path }}" ]; then
            # Root deployment - replace everything
            git rm -rf . 2>/dev/null || true
            shopt -s extglob
            cp -r ../!(node_modules|gh-pages-temp) .
          else
            # Subdirectory deployment - only update subdirectory
            mkdir -p ${{ inputs.deploy-path }}
            rm -rf ${{ inputs.deploy-path }}/*
            shopt -s extglob
            cp -r ../!(node_modules|gh-pages-temp) ${{ inputs.deploy-path }}/
          fi

          git add -A
          if git diff --cached --quiet; then
            echo "No changes to deploy"
          else
            git commit -m "Deploy to ${{ inputs.deploy-path || 'root' }}: ${{ github.sha }}"
            git push -u origin gh-pages
          fi
