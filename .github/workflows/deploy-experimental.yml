name: Deploy Experimental Branch

on:
  push:
    branches:
      - 'claude/experimental-01GVQNvaEXT11NUP4p9Vdo3q'

permissions:
  contents: write

jobs:
  deploy-experimental:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      # Reuse exact build steps from release.yml deploy-web job
      - name: Install dependencies and build
        run: |
          cd SourceCode/_devTools
          npm ci
          ln -s $(pwd)/node_modules ../WebApp/node_modules
          ln -s $(pwd)/node_modules ../DesktopWrappedWebapp/node_modules
          npm run build

      # Only difference: deploy to /experimental subdirectory
      - name: Deploy to gh-pages/experimental
        run: |
          cd SourceCode/WebApp
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git clone --single-branch --branch gh-pages https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git gh-pages-temp || git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git gh-pages-temp

          cd gh-pages-temp
          git checkout gh-pages 2>/dev/null || git checkout --orphan gh-pages

          mkdir -p experimental
          rm -rf experimental/*
          cp -r ../* experimental/
          rm -rf experimental/node_modules

          git add experimental/
          git commit -m "Deploy experimental: ${{ github.sha }}" || echo "No changes"
          git push origin gh-pages
